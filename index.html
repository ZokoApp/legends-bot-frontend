<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Legends Bot ‚Äì Producci√≥n</title>

<script>
const user = JSON.parse(localStorage.getItem("legends_user"));
if (!user) window.location.href = "login.html";
</script>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1220">

<style>
*{box-sizing:border-box}
body{
margin:0;
font-family:system-ui;
background:radial-gradient(circle at top,#0f172a,#020617);
color:#e5e7eb;
}

/* SPLASH */
#splash{
position:fixed;
inset:0;
background:radial-gradient(circle at top,#0f172a,#020617);
display:flex;
flex-direction:column;
justify-content:center;
align-items:center;
z-index:99999;
animation:fadeOut 1.2s ease forwards;
animation-delay:1.2s;
}

#splash img{
width:110px;
animation:logoPulse 1.2s ease infinite;
}

@keyframes logoPulse{
0%{transform:scale(0.9)}
50%{transform:scale(1)}
100%{transform:scale(0.9)}
}

@keyframes fadeOut{
to{opacity:0;pointer-events:none}
}

.container{max-width:420px;margin:0 auto;padding:28px 20px 40px}
.card{background:rgba(255,255,255,0.04);border-radius:20px;padding:26px 22px 28px;box-shadow:0 30px 60px rgba(0,0,0,.5)}

.user-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
.user-info{display:flex;align-items:center;gap:12px}
.user-info img{width:46px;height:46px;border-radius:50%}
.user-name{font-size:.8rem;color:#9ca3af}
.user-name strong{display:block;font-size:.95rem;color:#fff}

.verified {
  width:16px;
  height:16px;
  display:flex;
  align-items:center;
  justify-content:center;
}

  .company-menu {
  display: flex;
  gap: 12px;
}

.company-btn {
  flex: 1;
  padding: 14px;
  border-radius: 14px;
  border: none;
  background: #020617;
  color: white;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  border: 1px solid rgba(255,255,255,.1);
}

.company-btn.active {
  background: linear-gradient(145deg,#22c55e,#15803d);
  box-shadow: 0 0 12px rgba(34,197,94,.6);
}

.btn-logout{
padding:6px 14px;
border-radius:12px;
border:1px solid rgba(255,255,255,.2);
background:transparent;
color:#9ca3af;
font-size:.75rem;
cursor:pointer;
flex:none;
}

.field{margin-bottom:18px}
.field label{display:block;font-size:.75rem;color:#9ca3af;margin-bottom:6px}
.field input,.field select{
width:100%;
padding:14px;
border-radius:14px;
border:none;
background:#020617;
color:#e5e7eb;
font-size:.9rem;
}

.actions{display:flex;gap:12px;margin-top:20px}
button{flex:1;padding:14px;border-radius:16px;border:none;cursor:pointer;font-weight:600;font-size:.95rem}
.btn-primary{background:linear-gradient(135deg,#2563eb,#1e40af);color:#fff}
.btn-secondary{background:transparent;color:#9ca3af;border:1px solid rgba(255,255,255,.2)}

.status{margin-top:16px;font-size:.75rem;display:flex;gap:6px;align-items:center}
.dot{width:8px;height:8px;border-radius:50%;background:#22c55e}
pre{margin-top:16px;background:#020617;padding:12px;border-radius:12px;font-size:.75rem;white-space:pre-wrap}

/* MODALES */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;z-index:9999}
.modal-card{width:95%;max-width:520px;background:#020617;border-radius:20px;padding:18px;display:flex;flex-direction:column;max-height:90vh}
.modal-header{display:flex;justify-content:space-between;align-items:center;font-size:.9rem;margin-bottom:10px}
.modal-close{background:transparent;border:none;color:#aaa;font-size:1rem;cursor:pointer}
.modal-body{flex:1;overflow:auto}
.modal-body pre{background:#020617;padding:10px;border-radius:10px;font-size:.75rem;margin-bottom:10px}
.modal-body img{width:100%;border-radius:12px}
.modal-actions{display:flex;gap:8px;margin-top:12px}
.btn-modal{flex:1;padding:10px;border-radius:12px;border:none;cursor:pointer;font-size:.75rem;font-weight:600}
.btn-pdf{background:#2563eb;color:white}
.btn-wsp{background:#22c55e;color:white}
.btn-close{background:transparent;border:1px solid #555;color:#ccc}

/* =========================
   MODO TRABAJO (pantalla dedicada)
   ========================= */
#workMode{
position:fixed;
inset:0;
background:radial-gradient(circle at top,#0f172a,#020617);
display:none;
flex-direction:column;
justify-content:center;
align-items:center;
z-index:99998;
text-align:center;
}

#workMode img{
width:90px;
margin-bottom:20px;
animation:workPulse 1.4s ease-in-out infinite;
}

@keyframes workPulse{
0%{transform:scale(0.9);opacity:0.6}
50%{transform:scale(1);opacity:1}
100%{transform:scale(0.9);opacity:0.6}
}

#workText{
font-size:0.9rem;
color:#9ca3af;
margin-top:12px;
min-height:20px;
}
</style>
</head>

<body>

<div id="splash">
<img src="icons/icon-192.png">
</div>

<!-- MODO TRABAJO -->
<div id="workMode">
  <img src="icons/icon-192.png">
  <strong style="font-size:1rem">ü§ñ Legends Bot trabajando</strong>
  <div id="workText">Conectando con sistemas corporativos‚Ä¶</div>
</div>

<div class="container">
<div class="card">

<div class="user-header">
<div class="user-info">
<img src="icons/icon-192.png">
<div class="user-name">
<div style="display:flex;align-items:center;gap:6px">
  <strong id="userName"></strong>
  <span id="verifiedBadge" class="verified" style="display:none">
  <svg viewBox="0 0 24 24" width="16" height="16">
    <circle cx="12" cy="12" r="10" fill="#1d9bf0"/>
    <path d="M7 12.5l3 3 7-7"
          stroke="white"
          stroke-width="2.5"
          fill="none"
          stroke-linecap="round"
          stroke-linejoin="round"/>
  </svg>
</span>
</div>
<span id="userRole"></span>
</div>
</div>
<button class="btn-logout" onclick="openHistory()">Historial</button>
<button class="btn-logout" onclick="logout()">Salir</button>
</div>

<div class="field">
<label>COMPA√ë√çA</label>
<select id="company">
<option value="VTR">VTR</option>
<option value="CLARO">CLARO</option>
</select>
</div>

<div class="field">
<label>COMPA√ë√çA</label>

<div class="company-menu">
  <button class="company-btn" onclick="setCompany('VTR', this)">VTR</button>
  <button class="company-btn" onclick="setCompany('CLARO', this)">CLARO</button>
</div>

<input type="hidden" id="company" value="">
</div>

<div class="field"><label>DIRECCI√ìN</label><input id="address"></div>
<div class="field"><label>COMUNA</label><input id="comuna"></div>
<div class="field"><label>CUENTA DE FACTURACION</label><input id="rut"></div>

<div class="actions">
<button id="btnRun" class="btn-primary">Ejecutar</button>
<button id="btnClear" class="btn-secondary">Limpiar</button>
</div>

<div class="status">
<div class="dot"></div>
<span id="statusText">Conectado a Legends Bot</span>
</div>

<pre id="output"></pre>

</div>
</div>

<script src="app.js"></script>

<script>
/* =========================
   MODO TRABAJO (JS)
   ========================= */
const workMessages = [
  "Conectando con sistemas corporativos‚Ä¶",
  "Autenticando credenciales‚Ä¶",
  "Consultando base de datos Andes‚Ä¶",
  "Procesando informaci√≥n comercial‚Ä¶",
  "Validando resultados‚Ä¶",
  "Generando reporte final‚Ä¶"
];

let workInterval = null;

function showWorkMode(){
  document.getElementById("workMode").style.display = "flex";
  let i = 0;
  workInterval = setInterval(() => {
    document.getElementById("workText").innerText = workMessages[i % workMessages.length];
    i++;
  }, 2000);
}

function hideWorkMode(){
  document.getElementById("workMode").style.display = "none";
  clearInterval(workInterval);
}

/* =========================
   USER UI
   ========================= */
document.getElementById("userName").innerText = user.nombre;
document.getElementById("userRole").innerText = user.rol;

if (user.rol === "Admin") {
  document.getElementById("verifiedBadge").style.display = "flex";
}

function logout(){
  localStorage.removeItem("legends_user");
  window.location.href="login.html";
}
</script>

<!-- MODAL RESULTADO -->
<div id="resultModal" class="modal-overlay">
<div class="modal-card">
<div class="modal-header">
<strong>Resultado</strong>
<button class="modal-close" onclick="closeResultModal()">‚úñ</button>
</div>
<div class="modal-body">
<pre id="modalText"></pre>
<img id="modalImg"/>
</div>
<div class="modal-actions">
<button class="btn-modal btn-pdf" onclick="downloadPDF()">üìÑ PDF</button>
<button class="btn-modal btn-wsp" onclick="shareWhatsApp()">üì≤ WhatsApp</button>
<button class="btn-modal btn-close" onclick="closeResultModal()">Cerrar</button>
</div>
</div>
</div>

<!-- MODAL HISTORIAL -->
<div id="historyModal" class="modal-overlay">
<div class="modal-card">
<div class="modal-header">
<strong>Historial</strong>
<button class="modal-close" onclick="closeHistory()">‚úñ</button>
</div>
<div class="modal-body" id="historyList"></div>
<div class="modal-actions">
<button class="btn-modal btn-close" onclick="closeHistory()">Cerrar</button>
</div>
</div>
</div>

<!-- MODAL NOTA -->
<div id="noteModal" class="modal-overlay">
  <div class="modal-card">
    <div class="modal-header">
      <strong>Nota</strong>
      <button class="modal-close" onclick="closeNote()">‚úñ</button>
    </div>

    <div class="modal-body">
      <textarea id="noteText" style="width:100%;height:120px;background:#020617;color:white;border-radius:10px;padding:10px"></textarea>
    </div>

    <div class="modal-actions">
      <button class="btn-modal btn-pdf" onclick="saveNote()">Guardar</button>
      <button class="btn-modal btn-close" onclick="closeNote()">Cancelar</button>
    </div>
  </div>
</div>

</body>
</html>
